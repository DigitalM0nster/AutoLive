# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–ª–Ω—ã–º–∏ —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ü–æ–ª–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- **snapshotBefore** - –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **snapshotAfter** - –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π  
- **adminSnapshot** - –ø–æ–ª–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∫—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ)

### ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `ChangeLog` –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π
- –ù–∏–∫–∞–∫–∏—Ö –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–ª–µ–π –∏ —Å–≤—è–∑–µ–π
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å–Ω–∞–ø—à–æ—Ç–∞—Ö

### ‚úÖ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã
- –ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–Ω–∞–ø—à–æ—Ç–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∑–∞—è–≤–∫–∏ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –¢–æ–≤–∞—Ä: –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∫–∞—Ç–µ–≥–æ—Ä–∏—è + –æ—Ç–¥–µ–ª
- –û—Ç–¥–µ–ª: –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ + —Ç–æ–≤–∞—Ä—ã + –∑–∞—è–≤–∫–∏
- –ó–∞—è–≤–∫–∞: –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∫–ª–∏–µ–Ω—Ç + –º–µ–Ω–µ–¥–∂–µ—Ä + –æ—Ç–¥–µ–ª

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–¥–µ–ª—å ChangeLog
```sql
CREATE TABLE change_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    created_at DATETIME DEFAULT NOW(),
    
    -- –¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏
    entity_type VARCHAR(50), -- "user", "department", "product", "order"
    
    -- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
    message TEXT,
    
    -- –ü–û–õ–ù–´–ï —Å–Ω–∞–ø—à–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
    snapshot_before JSON, -- –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π
    snapshot_after JSON,  -- –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π
    admin_snapshot JSON,  -- –ü–æ–ª–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    
    -- –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    entity_id INT,
    admin_id INT,
    department_id INT
);
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```typescript
import { logUserChange } from "@/lib/universalLogging";

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await logUserChange({
    entityId: newUserId,
    adminId: adminId,
    message: "–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    afterData: newUserData
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await logUserChange({
    entityId: userId,
    adminId: adminId,
    message: "–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å—Ç–∞—Ç—É—Å, –æ—Ç–¥–µ–ª, —Ä–æ–ª—å",
    beforeData: oldUserData,
    afterData: newUserData
});

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await logUserChange({
    entityId: userId,
    adminId: adminId,
    message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω",
    beforeData: userDataBeforeDelete
});
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
```typescript
import { logDepartmentChange, logProductChange, logOrderChange } from "@/lib/universalLogging";

// –û—Ç–¥–µ–ª
await logDepartmentChange({
    entityId: departmentId,
    adminId: adminId,
    message: "–û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞",
    beforeData: oldDepartmentData,
    afterData: newDepartmentData
});

// –¢–æ–≤–∞—Ä
await logProductChange({
    entityId: productId,
    adminId: adminId,
    message: "–ò–∑–º–µ–Ω–µ–Ω–∞ —Ü–µ–Ω–∞ –∏ –æ—Ç–¥–µ–ª —Ç–æ–≤–∞—Ä–∞",
    beforeData: oldProductData,
    afterData: newProductData
});

// –ó–∞—è–≤–∫–∞
await logOrderChange({
    entityId: orderId,
    adminId: adminId,
    message: "–ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
    beforeData: oldOrderData,
    afterData: newOrderData
});
```

## üìà –ê–Ω–∞–ª–∏–∑ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```typescript
// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userLogs = await prisma.changeLog.findMany({
    where: { 
        entityType: "user",
        entityId: userId 
    },
    orderBy: { createdAt: 'desc' }
});

// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
userLogs.forEach(log => {
    const before = JSON.parse(log.snapshotBefore || '{}');
    const after = JSON.parse(log.snapshotAfter || '{}');
    const admin = JSON.parse(log.adminSnapshot || '{}');
    
    console.log(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç ${admin.first_name} ${admin.last_name}:`);
    console.log(`–°—Ç–∞—Ç—É—Å: ${before.status} ‚Üí ${after.status}`);
    console.log(`–û—Ç–¥–µ–ª: ${before.department?.name} ‚Üí ${after.department?.name}`);
});
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
```typescript
// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É
const lastLog = await prisma.changeLog.findFirst({
    where: {
        entityType: "user",
        entityId: userId,
        createdAt: { lte: targetDate }
    },
    orderBy: { createdAt: 'desc' }
});

const userData = JSON.parse(lastLog.snapshotAfter || lastLog.snapshotBefore || '{}');
console.log("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", userData);
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### 1. –ü–æ–ª–Ω–∞—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –î–∞–∂–µ –µ—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω, —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç
- –î–∞–∂–µ –µ—Å–ª–∏ –æ—Ç–¥–µ–ª —É–¥–∞–ª–µ–Ω, —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–º
- –ù–∏–∫–∞–∫–∏—Ö –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö

### 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å
- –û–¥–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π
- –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 3. –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã
- –ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
- –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ —Å–Ω–∞–ø—à–æ—Ç
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### 4. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –õ–µ–≥–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

### –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (UserLog)
```typescript
// –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± - –º–Ω–æ–≥–æ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –ø–æ–ª–µ–π
await prisma.userLog.create({
    data: {
        action: "update",
        adminId: adminId,
        targetUserId: userId,
        departmentId: departmentId,
        message: "–û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        snapshotBefore: JSON.stringify(beforeData),
        snapshotAfter: JSON.stringify(afterData),
        adminSnapshot: JSON.stringify(adminData),
        userId: adminId, // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
    }
});
```

### –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (ChangeLog)
```typescript
// –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± - —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
await prisma.changeLog.create({
    data: {
        entityType: "user",
        message: "–û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
        snapshotBefore: JSON.stringify(beforeData),
        snapshotAfter: JSON.stringify(afterData),
        adminSnapshot: JSON.stringify(adminData),
        entityId: userId,
        adminId: adminId,
        departmentId: departmentId,
    }
});
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `ChangeLog`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç Prisma (`npx prisma generate`)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤—ã–∑–æ–≤—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é** –¥–ª—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
2. **–û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç Prisma** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
3. **–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤—ã–∑–æ–≤—ã** –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã–µ
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** API –¥–ª—è –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ 